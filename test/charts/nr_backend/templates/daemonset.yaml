---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: &app nrdot-collector-daemonset
  labels:
    app: *app
spec:
  selector:
    matchLabels:
      app: *app
  template:
    metadata:
      labels:
        app: *app
    spec:
      containers:
        - name: *app
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: "{{ .Values.image.pullPolicy }}"
          {{- if (contains "experimental" .Values.image.repository) }}
          args:
            - "--config=/etc/otelcol/config.yaml"
          volumeMounts:
            - name: nrdot-collector-minimal-config
              mountPath: /etc/otelcol/config.yaml
              subPath: config.yaml
          {{- end }}
          ports:
            - name: health
              containerPort: 13133
          env:
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: collector-secrets
                  key: backendUrl
            - name: NEW_RELIC_LICENSE_KEY
              valueFrom:
                secretKeyRef:
                  name: collector-secrets
                  key: nrIngestKey
            - name: KUBE_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: OTEL_RESOURCE_ATTRIBUTES
              value: "testKey={{ .Values.testKey }}-$(KUBE_NODE_NAME)"
      {{- if (contains "experimental" .Values.image.repository) }}
      volumes:
        - name: nrdot-collector-minimal-config
          configMap:
            name: nrdot-collector-minimal-config
      {{- end }}

---
{{- if (contains "experimental" .Values.image.repository) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: nrdot-collector-minimal-config
data:
  config.yaml: |
    receivers:
      hostmetrics:
    processors:
      resourcedetection/env:
        detectors: ["env"]
        timeout: 2s
        override: true
    exporters:
      otlphttp:
        endpoint: ${env:OTEL_EXPORTER_OTLP_ENDPOINT}
        headers:
          "api-key": ${env:NEW_RELIC_LICENSE_KEY}
    service:
      extensions:
        - health_check
      pipelines:
        metrics/host:
          receivers:
            - hostmetrics
          processors:
            - resourcedetection/env
          exporters:
            - otlphttp
{{- end }}