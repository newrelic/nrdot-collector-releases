# yaml-language-server: $schema=https://goreleaser.com/static/schema.json
version: 2
project_name: opentelemetry-collector-releases-nightly
builds:
  - id: nr-otel-collector
    goos:
      - linux
      - windows
    goarch:
      - amd64
      - arm64
    ignore:
      - goos: windows
        goarch: arm64
    dir: _build
    binary: nr-otel-collector
    ldflags:
      - -s
      - -w
    flags:
      - -trimpath
    env:
      - CGO_ENABLED=0

archives:
  - id: nr-otel-collector
    builds:
      - nr-otel-collector
    name_template: '{{ .Binary }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}{{ if .Arm }}v{{ .Arm }}{{ end }}{{ if .Mips }}_{{ .Mips }}{{ end }}'

    format_overrides:
      - goos: windows
        formats:
          - zip

nfpms:
  - package_name: nr-otel-collector

    # Replace arch for rpm from amd64 to x86_64 to be consistent with our rpm repo.
    file_name_template: >-
      {{ .PackageName }}_{{ .Version }}_{{ .Os }}_
      {{- if not (eq (filter .ConventionalFileName "\\.rpm$") "") }}
        {{- replace .Arch "amd64" "x86_64" }}
      {{- else }}
        {{- .Arch }}
      {{- end }}
      {{- with .Arm }}v{{ . }}{{- end }}
      {{- with .Mips }}_{{ . }}{{- end }}
      {{- if not (eq .Amd64 "v1") }}{{ .Amd64 }}{{- end }}

    contents:
      - src: nr-otel-collector.service
        dst: /lib/systemd/system/nr-otel-collector.service
      - src: nr-otel-collector.conf
        dst: /etc/nr-otel-collector/nr-otel-collector.conf
        type: config|noreplace
      - src: configs/nr-otel-collector-agent-linux.yaml
        dst: /etc/nr-otel-collector/config.yaml
        type: config
    scripts:
      preinstall: preinstall.sh
      postinstall: postinstall.sh
      preremove: preremove.sh
    id: nr-otel-collector
    builds:
      - nr-otel-collector
    formats:
      - deb
      - rpm
    maintainer: New Relic <caos-team@newrelic.com>
    description: OpenTelemetry Collector - nr-otel-collector
    license: Apache 2.0
    rpm:
      signature:
        key_file: "{{ .Env.GPG_KEY_PATH }}"
    deb:
      signature:
        key_file: "{{ .Env.GPG_KEY_PATH }}"

dockers:
  - goos: linux
    goarch: amd64
    dockerfile: Dockerfile
    image_templates:
      - '{{ .Env.REGISTRY }}:{{ .Version }}-nightly-amd64'
      - '{{ .Env.REGISTRY }}:nightly-amd64'
    extra_files:
      - configs/nr-otel-collector-agent-linux.yaml
    build_flag_templates:
      - --pull
      - --platform=linux/amd64
      - --label=org.opencontainers.image.created={{.Date}}
      - --label=org.opencontainers.image.name={{.ProjectName}}
      - --label=org.opencontainers.image.revision={{.FullCommit}}
      - --label=org.opencontainers.image.version={{.Version}}-nightly
      - --label=org.opencontainers.image.source={{.GitURL}}
    use: buildx
  - goos: linux
    goarch: arm64
    dockerfile: Dockerfile
    image_templates:
      - '{{ .Env.REGISTRY }}:{{ .Version }}-nightly-arm64'
      - '{{ .Env.REGISTRY }}:nightly-arm64'
    extra_files:
      - configs/nr-otel-collector-agent-linux.yaml
    build_flag_templates:
      - --pull
      - --platform=linux/arm64
      - --label=org.opencontainers.image.created={{.Date}}
      - --label=org.opencontainers.image.name={{.ProjectName}}
      - --label=org.opencontainers.image.revision={{.FullCommit}}
      - --label=org.opencontainers.image.version={{.Version}}-nightly
      - --label=org.opencontainers.image.source={{.GitURL}}
    use: buildx

docker_manifests:
  - name_template: '{{ .Env.REGISTRY }}:{{ .Version }}-nightly'
    image_templates:
      - '{{ .Env.REGISTRY }}:{{ .Version }}-nightly-amd64'
      - '{{ .Env.REGISTRY }}:{{ .Version }}-nightly-arm64'
  - name_template: '{{ .Env.REGISTRY }}:nightly'
    image_templates:
      - '{{ .Env.REGISTRY }}:nightly-amd64'
      - '{{ .Env.REGISTRY }}:nightly-arm64'

# Skip creating/updating gh release.
release:
  disable: true

signs:
  - args: ["--batch", "-u", "{{ .Env.GPG_FINGERPRINT }}", "--output", "${signature}", "--detach-sign", "${artifact}"]
    artifacts: all

checksum:
  name_template: "{{ .ArtifactName }}.sum"
  # Create a checksum per each artifact.
  split: true
  # This is the default, but we are explicit here for clarity.
  algorithm: sha256

# Skip auto-generating changelog.
changelog:
  disable: true

snapshot:
  version_template: "{{ incpatch .Version }}-SNAPSHOT-{{.ShortCommit}}"

blobs:
  - provider: s3
    region: us-east-1
    bucket: nr-releases
    directory: 'opentelemetry-collector-releases/nightly'
