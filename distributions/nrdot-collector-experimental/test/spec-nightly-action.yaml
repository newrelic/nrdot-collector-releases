description: nrdot-collector-experimental E2E Nightly Test (Action-based)

# Scoping is achieved via an implicit attribute `testKey=${SCENARIO_TAG}` expected on all tested telemetry

scenarios:
  - description: k8s node host metrics smoke test
    before:
      - kubectl create ns nr-${SCENARIO_TAG}
      - |
        helm upgrade --install ${SCENARIO_TAG} ../../../test/charts/nr_backend \
        --namespace nr-${SCENARIO_TAG} \
        --set image.tag=${IMAGE_TAG} \
        --set image.repository=${IMAGE_REPO} \
        --set image.pullPolicy=Always \
        --set secrets.nrBackendUrl=${NR_BACKEND_URL} \
        --set secrets.nrIngestKey=${LICENSE_KEY} \
        --set testKey=${SCENARIO_TAG} \
        --set clusterName=${CLUSTER_NAME} \
        --set demoService.enabled=true
    after:
      - kubectl logs -l app=nrdot-collector-daemonset -n nr-${SCENARIO_TAG} --all-containers --prefix=true
      - kubectl get all -o wide -n nr-${SCENARIO_TAG}
      - helm uninstall ${SCENARIO_TAG} --namespace nr-${SCENARIO_TAG}
      - kubectl delete namespace nr-${SCENARIO_TAG}
    tests:
      nrqls:
        # Smoke test: any system metric
        - query: FROM Metric SELECT count(*) as system_metric_count WHERE metricName LIKE 'system.%'
          expected_results:
            - key: system_metric_count
              lowerBoundedValue: 1
