description: nrdot-collector-experimental E2E Nightly Test

# Scoping is achieved via an implicit attribute `testKey=${SCENARIO_TAG}` expected on all tested telemetry

scenarios:
  - description: smoke test (using system.%)
    before:
      - kubectl create ns nr-${SCENARIO_TAG}
      - |
        kubectl create secret generic 'collector-secrets' --namespace=nr-${SCENARIO_TAG} \
        --from-literal="nrIngestKey=${LICENSE_KEY}" --from-literal="nrBackendUrl=${NR_BACKEND_URL}" \
        --from-literal="serviceName=nrdot-collector-experimental-e2e" --from-literal="scenarioTag=${SCENARIO_TAG}"
      - "helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts || echo 'skipping repo add: open-telemetry repo already exists'"
      - |
        chart_version=$(../../../scripts/get-otel-collector-chart-version.sh)
        helm upgrade --install ${SCENARIO_TAG} open-telemetry/opentelemetry-collector \
        --namespace nr-${SCENARIO_TAG} --version ${chart_version} \
        --values ./smoke-collector-values.yaml \
        --set image.tag=${IMAGE_TAG} \
        --set image.repository=${IMAGE_REPO}
    after:
      - kubectl logs -l e2eTestLogSelector=nrdot-collector-experimental-e2e -n nr-${SCENARIO_TAG} --all-containers --prefix=true
      - kubectl get all -o wide
      - helm uninstall ${SCENARIO_TAG} --namespace nr-${SCENARIO_TAG}
      - kubectl delete namespace nr-${SCENARIO_TAG}
    tests:
      # Tests for existence of signal + specific attributes
      nrqls:
        - query: FROM Metric SELECT count(system.%) as system_count
          expected_results:
            - key: system_count
              lowerBoundedValue: 1
