name: "Get CI Workflow Run"
description: "Find the CI workflow run for a specific SHA, or get the last successful commit on a branch"
inputs:
  github-token:
    description: "GitHub token for API access"
    required: false
    default: ${{ github.token }}
  branch:
    description: "Branch to check for successful commits (ignored if sha is provided)"
    required: false
    default: "main"
  sha:
    description: "Specific commit SHA to find the workflow run for (if provided, branch is ignored)"
    required: false
    default: ""
outputs:
  sha:
    description: "SHA of the last successful commit"
    value: ${{ steps.get-commit.outputs.successful_sha }}
  short-sha:
    description: "Short SHA of the last successful commit"
    value: ${{ steps.get-commit.outputs.short_sha }}
  workflow-run-id:
    description: "Workflow run ID that created artifacts for this commit"
    value: ${{ steps.get-commit.outputs.workflow_run_id }}
runs:
  using: "composite"
  steps:
    - name: Get CI Workflow Run
      id: get-commit
      shell: bash
      run: |
        echo "Repository: ${{ github.repository }}"

        # Build API parameters based on search mode
        if [[ -n "${{ inputs.sha }}" ]]; then
          echo "Finding CI workflow run for specific SHA: ${{ inputs.sha }}"
          API_PARAMS=(--field head_sha="${{ inputs.sha }}" --field event="push")
        else
          echo "Finding last successful CI workflow run on ${{ inputs.branch }}..."
          API_PARAMS=(--field branch="${{ inputs.branch }}" --field event="push")
        fi

        # Single API call with dynamic parameters
        workflow_data=$(gh api "/repos/${{ github.repository }}/actions/runs" \
          -X GET \
          "${API_PARAMS[@]}" \
          --field status="completed" \
          --field conclusion="success" \
          --field per_page="50" \
          --jq 'first(.workflow_runs[] | select(.name == "ðŸ”„ CI | PR / Merge") | {id, head_sha, conclusion})' 2>&1)

        echo "Raw workflow_data result: '$workflow_data'"
        workflow_run_id=$(echo "$workflow_data" | jq -r '.id')
        sha=$(echo "$workflow_data" | jq -r '.head_sha')
        short_sha=${sha:0:7}

        if [[ -z "$workflow_data" || "$workflow_data" == "null" ]]; then
          echo "âŒ No workflow run found."
          exit 1
        elif [[ -z "$workflow_run_id" || "$workflow_run_id" == "null" ]]; then
          echo "âŒ Could not extract workflow run ID."
          exit 1
        else
          echo "successful_sha=$sha" >> $GITHUB_OUTPUT
          echo "short_sha=$short_sha" >> $GITHUB_OUTPUT
          echo "workflow_run_id=$workflow_run_id" >> $GITHUB_OUTPUT
          echo "âœ… Found successful commit: $short_sha (workflow run: $workflow_run_id)"
        fi
      env:
        GH_TOKEN: ${{ inputs.github-token }}
