name: ðŸ”„ CI | Nightly Tests (Regular & FIPS)
on:
  workflow_dispatch:
  schedule:
    # Scheduled to run in the morning (ET) on every day-of-week from Monday through Friday.
    - cron: '0 10 * * 1-5'

concurrency:
  group: ci-nightly
  cancel-in-progress: false

permissions:
  contents: read
  actions: read
  statuses: read

env:
  REGISTRY: "${{ secrets.OTELCOMM_AWS_TEST_ACC_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com"
jobs:
  setup:
    name: Setup Workflow
    runs-on: ubuntu-latest
    outputs:
      distributions: ${{ steps.discover.outputs.distributions }}
      successful-sha: ${{ steps.get-commit.outputs.sha }}
      short-sha: ${{ steps.get-commit.outputs.short-sha }}
      workflow-run-id: ${{ steps.get-commit.outputs.workflow-run-id }}  
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/actions
            distributions
      - name: Discover Distributions
        id: discover
        uses: ./.github/actions/discover-distributions
      - name: Get Last Successful Commit
        id: get-commit
        uses: ./.github/actions/get-ci-workflow-run
        with:
          branch: main
  verify-artifacts:
    name: Verify Artifacts (${{ matrix.distribution }}${{ matrix.fips && ' - FIPS' || '' }})
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        distribution: ${{ fromJson(needs.setup.outputs.distributions) }}
        fips: [false, true]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/actions
      - name: Verify Artifacts Exist for ${{ matrix.distribution }}${{ matrix.fips && ' - FIPS' || '' }}
        uses: ./.github/actions/verify-artifacts
        with:
          github-token: ${{ github.token }}
          distribution: ${{ matrix.distribution }}
          commit-sha: ${{ needs.setup.outputs.successful-sha }}
          fips: ${{ matrix.fips }}
  e2e-tests:
    name: Nightly E2E (${{ matrix.distribution }}${{ matrix.fips && ' - FIPS' || '' }})
    if: ${{ !github.event.act }}
    needs: [setup, verify-artifacts]
    strategy:
      fail-fast: false
      matrix:
        distribution: ${{ fromJson(needs.setup.outputs.distributions) }}
        fips: [false, true]
    uses: ./.github/workflows/deploy-and-e2e.yaml
    with:
      ref: ${{ needs.setup.outputs.successful-sha }}
      workspace_prefix: nightly
      distro: ${{ matrix.distribution }}
      fips: ${{ matrix.fips }}
      execute_destroy: false
      workflow_run_id: ${{ needs.setup.outputs.workflow-run-id }}
    secrets:
      aws_access_key_id: ${{ secrets.OTELCOMM_AWS_TEST_ACC_ACCESS_KEY_ID }}
      aws_secret_access_key: ${{ secrets.OTELCOMM_AWS_TEST_ACC_SECRET_ACCESS_KEY }}
      aws_account_id: ${{ secrets.OTELCOMM_AWS_TEST_ACC_ACCOUNT_ID }}
      nr_backend_url: ${{ secrets.NR_STAGING_BACKEND_URL }}
      nr_ingest_key: ${{ secrets.OTELCOMM_NR_INGEST_KEY }}
      nr_api_key: ${{ secrets.OTELCOMM_NR_API_KEY }}
      nr_account_id: ${{ secrets.OTELCOMM_NR_TEST_ACCOUNT_ID }}
      nr_api_base_url: ${{ secrets.NR_STAGING_API_BASE_URL }}
