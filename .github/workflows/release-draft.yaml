name: üè∑Ô∏è Release | Draft

on:
  push:
    tags:
      - "*.*.*"

env:
  REGISTRY: ${{ secrets.OTELCOMM_AWS_TEST_ACC_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com

permissions:
  contents: write
  packages: write

jobs:
  setup:
    name: Setup Workflow
    runs-on: ubuntu-latest
    outputs:
      distributions: ${{ steps.discover.outputs.distributions }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/actions
            distributions

      - name: Discover Distributions
        id: discover
        uses: ./.github/actions/discover-distributions

  verify-artifacts:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        distribution: ${{ fromJson(needs.setup.outputs.distributions) }}
        fips: [false, true]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/actions/verify-artifacts

      - name: Verify CI Artifacts Exist
        uses: ./.github/actions/verify-artifacts
        with:
          distribution: ${{ matrix.distribution }}
          fips: ${{ matrix.fips }}
          commit-sha: ${{ github.sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  draft-release:
    runs-on: ubuntu-latest
    needs: [setup, verify-artifacts]
    outputs:
      release-tag: ${{ steps.get-release.outputs.release-tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # required for tag metadata

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: "~1.24"
          check-latest: true

      - name: Draft Release From Root Config
        id: goreleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "2.11.2"
          args: --clean --timeout 2h
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Release Information
        id: get-release
        run: |
          # Extract tag from GoReleaser metadata
          tag=$(echo '${{ steps.goreleaser.outputs.metadata }}' | jq -r '.tag')
          version=$(echo '${{ steps.goreleaser.outputs.metadata }}' | jq -r '.version')
          echo "Looking up release for tag: $tag"

          # Find draft release with retries to handle eventual consistency
          max_retries=10
          retry_count=0
          release_info=""

          while [ $retry_count -lt $max_retries ]; do
            echo "Attempt $((retry_count + 1)) of $max_retries..."
            
            # Fetch releases and filter for the specific tag
            all_releases_first_page=$(gh api repos/${{ github.repository }}/releases)
            release_info=$(echo "$all_releases_first_page" | jq ".[] | select(.tag_name == \"$tag\")")
            
            # Break if we found the release
            if [ -n "$release_info" ]; then
              echo "‚úÖ Release found!"
              break
            fi
            
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $max_retries ]; then
              echo "‚è≥ Release not found, waiting 10s before retry..."
              sleep 10
            fi
          done

          # If still not found after all retries, output debug info and fail
          if [ -z "$release_info" ]; then
            echo "‚ùå Release with tag $tag not found after $max_retries attempts."
            echo "Full API response:"
            echo "$all_releases_first_page"
            exit 1
          fi

          release_id=$(echo "$release_info" | jq -r '.id')
          release_url=$(echo "$release_info" | jq -r '.html_url')

          echo "release-tag=$tag" >> $GITHUB_OUTPUT

          echo "üöÄ Release Draft Created!"
          echo "Release ID: $release_id"
          echo "Release URL: $release_url"
          echo "Release Tag: $tag"
          echo "Release Version: $version"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  upload-artifacts:
    runs-on: ubuntu-latest
    needs: draft-release
    strategy:
      matrix:
        distribution:
          - nrdot-collector
          - nrdot-collector-host
          - nrdot-collector-k8s
        fips: [false, true]
    steps:
      - name: Checkout (sparse)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/actions

      - name: Get CI workflow run for this SHA
        id: get-workflow-run
        uses: ./.github/actions/get-ci-workflow-run
        with:
          sha: ${{ github.sha }}

      - name: Download CI Artifacts
        uses: actions/download-artifact@v4
        with:
          name: goreleaser_output_${{ matrix.distribution }}${{ matrix.fips && '-fips' || '' }}_${{ github.sha }}
          path: artifacts/
          run-id: ${{ steps.get-workflow-run.outputs.workflow-run-id }}
          github-token: ${{ github.token }}

      - name: List Downloaded Artifacts
        run: |
          echo "Downloaded artifacts for ${{ matrix.distribution }}${{ matrix.fips && ' (FIPS)' || '' }}:"
          find artifacts -type f | head -100

      - name: Upload Artifacts to Release
        run: |
          if [ ! -f "artifacts/dist/artifacts.json" ]; then
            echo "‚ùå artifacts.json not found"
            exit 1
          fi

          echo "üì¶ Uploading artifacts for ${{ matrix.distribution }}${{ matrix.fips && ' (FIPS)' || '' }}"

          # Read artifacts.json and upload each file with a path
          jq -r '.[] | select(has("path")) | .path' artifacts/dist/artifacts.json | while IFS= read -r artifact_path; do
            if [ -f "artifacts/$artifact_path" ]; then
              echo "‚¨ÜÔ∏è  Uploading: $artifact_path"
              gh release upload ${{ needs.draft-release.outputs.release-tag }} \
                "artifacts/$artifact_path" \
                --clobber
            else
              echo "‚ö†Ô∏è  File not found: artifacts/$artifact_path"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
