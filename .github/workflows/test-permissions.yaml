name: ðŸª² Workflow Experiments

on:
  pull_request:
    branches: [main]

permissions:
  contents: write
  packages: write

jobs:
  draft-release:
    runs-on: ubuntu-latest
    outputs:
      release-tag: ${{ steps.get-release.outputs.release-tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # required for tag metadata

      - name: Get Release Information
        id: get-release
        run: |
          tag='1.6.0-test'
          
          # Retry logic: try up to 100 times with 10s delay
          max_retries=100
          retry_count=0
          release_info=""

          while [ $retry_count -lt $max_retries ]; do
            echo "Attempt $((retry_count + 1)) of $max_retries..."
            
            # Fetch releases and filter for the specific tag
            all_releases=$(gh api repos/${{ github.repository }}/releases)
            release_info=$(echo "$all_releases" | jq ".[] | select(.tag_name == \"$tag\")")
            
            # Break if we found the release
            if [ -n "$release_info" ]; then
              echo "âœ… Release found!"
              break
            fi
            
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $max_retries ]; then
              echo "â³ Release not found, waiting 10s before retry..."
              sleep 10
            fi
          done

          # If still not found after all retries, output debug info and fail
          if [ -z "$release_info" ]; then
            echo "âŒ Release with tag $tag not found after $max_retries attempts."
            echo "Full API response:"
            echo "$all_releases"
            exit 1
          fi

          release_id=$(echo "$release_info" | jq -r '.id')
          release_url=$(echo "$release_info" | jq -r '.html_url')

          echo "release-tag=$tag" >> $GITHUB_OUTPUT

          echo "ðŸš€ Release Draft Created!"
          echo "Release ID: $release_id"
          echo "Release URL: $release_url"
          echo "Release Tag: $tag"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}